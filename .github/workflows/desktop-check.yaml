name: Check
on:
  pull_request:

jobs:
  desktop-check:
    name: Desktop Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Checkout world_feed_integration_tests_data
        uses: actions/checkout@v2
        with:
          repository: omapsapp/world_feed_integration_tests_data
          path: data/world_feed_integration_tests_data

      - name: Configure
        shell: bash
        run: |
          ./configure.sh

      - name: Install dependencies
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -y \
              cmake \
              ninja-build \
              clang \
              ccache \
              python \
              qtbase5-dev \
              libqt5svg5-dev \
              libc++-dev \
              libboost-iostreams-dev \
              libglu1-mesa-dev \
              libsqlite3-dev \
              zlib1g-dev

      - name: Restore cache
        uses: actions/cache@v2
        with:
          path: ~/.ccache
          key: desktop-cache

      - name: Configure
        shell: bash
        run: |
          ccache -M 4G
          export CC="ccache clang"
          export CXX="ccache clang++"
          cmake . -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug

      - name: Compile
        shell: bash
        run: cmake --build build --target desktop --target tests

      - name: Test
        shell: bash
        working-directory: build
        # partners_api_tests - https://github.com/omapsapp/omapsapp/issues/218
        # traffic_tests - requires API key
        # opening_hours_tests - https://github.com/omapsapp/omapsapp/issues/219
        # opening_hours_supported_features_tests - https://github.com/omapsapp/omapsapp/issues/219
        # opening_hours_integration_tests - https://github.com/omapsapp/omapsapp/issues/219
        # routing_consistency_tests - https://github.com/omapsapp/omapsapp/issues/220
        # routing_integration_tests - https://github.com/omapsapp/omapsapp/issues/221
        # routing_quality_tests - https://github.com/omapsapp/omapsapp/issues/215
        # world_feed_integration_tests - https://github.com/omapsapp/omapsapp/issues/216
        # storage_integration_tests - https://github.com/omapsapp/omapsapp/issues/222
        # generator_tests - https://github.com/omapsapp/omapsapp/issues/224
        # generator_integration_tests - https://github.com/omapsapp/omapsapp/issues/225
        # drape_tests - requires X Window
        run: |
          ../tools/python/run_desktop_tests.py \
            -o /dev/stdout \
            -f $PWD \
            -e partners_api_tests \
            -e traffic_tests \
            -e opening_hours_tests \
            -e opening_hours_supported_features_tests \
            -e opening_hours_integration_tests \
            -e routing_consistency_tests \
            -e routing_integration_tests \
            -e routing_quality_tests \
            -e world_feed_integration_tests \
            -e storage_integration_tests \
            -e generator_tests \
            -e generator_integration_tests \
            -e drape_tests
